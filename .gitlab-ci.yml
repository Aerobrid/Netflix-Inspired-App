# Use Debian Bullseye Node image so OpenSSL 1.1 (libcrypto.so.1.1) is available
# This avoids installing libssl manually in the job.
image: node:18-bullseye

stages:
  - build

variables:
  NODE_ENV: production

  # Ensure devDependencies are installed in CI (vite, eslint, jest, etc.)
  NPM_CONFIG_PRODUCTION: "false"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - frontend/node_modules/
    - node_modules/

build:
  stage: build
  image: node:18-bullseye
  script:
    - echo "Installing frontend dependencies"
    - npm ci --prefix frontend --include=dev
    - echo "Installing root dependencies"
    - npm ci --include=dev
    - echo "Building App"
    - npm run build
    - echo "Running tests"
    - npm test --silent
  artifacts:
    paths:
      - build/
      - dist/
    expire_in: 1 day
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      when: always
    - when: never
